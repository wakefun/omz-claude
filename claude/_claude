#compdef claude

_claude() {
  setopt local_options extended_glob
  local curcontext="$curcontext" state line
  typeset -A opt_args
  local -a settings_names settings_shortcuts settings_descs
  local settings_loaded=0

  _claude_load_settings() {
    local f base
    settings_names=()
    settings_shortcuts=()
    settings_descs=()
    for f in ~/.claude/settings.*.json(N); do
      base=${f:t}; base=${base#settings.}; base=${base%.json}
      settings_names+=("$base")
      settings_shortcuts+=("$base")
      settings_descs+=("settings >> $base")
    done
    settings_loaded=1
  }

  _arguments -s -C \
    '(-h --help)'{-h,--help}'[Display help]' \
    '(-v --version)'{-v,--version}'[Output version]' \
    '(-d --debug)'{-d,--debug}'[Enable debug mode]:filter:' \
    '--verbose[Override verbose mode]' \
    '(-p --print)'{-p,--print}'[Print response and exit]' \
    '--output-format[Output format]:format:(text json stream-json)' \
    '--json-schema[JSON Schema]:schema:' \
    '--include-partial-messages[Include partial message chunks]' \
    '--input-format[Input format]:format:(text stream-json)' \
    '--mcp-debug[DEPRECATED]' \
    '--dangerously-skip-permissions[Bypass all permission checks]' \
    '--allow-dangerously-skip-permissions[Enable bypassing permission checks]' \
    '--replay-user-messages[Re-emit user messages]' \
    '--allowedTools[Allowed tools]:tools:' \
    '--allowed-tools[Allowed tools]:tools:' \
    '--tools[Available tools]:tools:' \
    '--disallowedTools[Denied tools]:tools:' \
    '--disallowed-tools[Denied tools]:tools:' \
    '--mcp-config[MCP config files]:config:_files -g "*.json"' \
    '--system-prompt[System prompt]:prompt:' \
    '--append-system-prompt[Append system prompt]:prompt:' \
    '--permission-mode[Permission mode]:mode:(acceptEdits bypassPermissions default dontAsk plan)' \
    '(-c --continue)'{-c,--continue}'[Continue most recent conversation]' \
    '(-r --resume)'{-r,--resume}'[Resume conversation]:session:' \
    '--fork-session[Create new session ID when resuming]' \
    '--no-session-persistence[Disable session persistence]' \
    '--model[Model]:model:' \
    '--agent[Agent]:agent:' \
    '--betas[Beta headers]:betas:' \
    '--fallback-model[Fallback model]:model:' \
    '--settings[Settings file]:settings:->settings' \
    '--settings=[Settings file]:settings:->settings' \
    '--add-dir[Additional directories]:dir:_files -/' \
    '--ide[Connect to IDE on startup]' \
    '--strict-mcp-config[Only use MCP from --mcp-config]' \
    '--session-id[Session ID]:uuid:' \
    '--agents[Custom agents JSON]:json:' \
    '--setting-sources[Setting sources]:sources:' \
    '--plugin-dir[Plugin directories]:dir:_files -/' \
    '--disable-slash-commands[Disable slash commands]' \
    '*: :->args'

  case $state in
    settings)
      (( settings_loaded )) || _claude_load_settings
      local curword needle
      local -a matched_names matched_descs
      local i

      curword=${words[CURRENT]}
      needle=${curword##*/}
      needle=${needle#settings.}
      needle=${needle%.json}

      if [[ -n $needle ]]; then
        for (( i = 1; i <= ${#settings_names}; i++ )); do
          local cand_prefix=${settings_names[i]:0:${#needle}}
          if [[ ${(L)cand_prefix} == ${(L)needle} ]]; then
            matched_names+=("${settings_names[i]}")
            matched_descs+=("${settings_descs[i]}")
          fi
        done
      else
        matched_names=("${settings_names[@]}")
        matched_descs=("${settings_descs[@]}")
      fi

      (( $#matched_names )) && compadd -V settings -X 'settings file' -d matched_descs -P '~/.claude/settings.' -S '.json ' -a matched_names
      ;;
    args)
      local -a commands
      commands=(
        'mcp:Configure and manage MCP servers'
        'plugin:Manage Claude Code plugins'
        'setup-token:Set up authentication token'
        'doctor:Check auto-updater health'
        'update:Check for updates'
        'install:Install Claude Code native build'
      )

      (( settings_loaded )) || _claude_load_settings
      local curword needle
      local -a matched_shortcuts matched_descs matched_commands
      local i entry name

      curword=${words[CURRENT]}
      needle=$curword

      if [[ -n $needle ]]; then
        for (( i = 1; i <= ${#settings_shortcuts}; i++ )); do
          local cand_prefix=${settings_shortcuts[i]:0:${#needle}}
          if [[ ${(L)cand_prefix} == ${(L)needle} ]]; then
            matched_shortcuts+=("${settings_shortcuts[i]}")
            matched_descs+=("${settings_descs[i]}")
          fi
        done
      else
        matched_shortcuts=("${settings_shortcuts[@]}")
        matched_descs=("${settings_descs[@]}")
      fi

      (( $#matched_shortcuts )) && compadd -V shortcuts -X 'settings shortcut' -d matched_descs -P '--settings ~/.claude/settings.' -S '.json ' -a matched_shortcuts

      if [[ -n $needle ]]; then
        for entry in "${commands[@]}"; do
          name=${entry%%:*}
          local name_prefix=${name:0:${#needle}}
          if [[ ${(L)name_prefix} == ${(L)needle} ]]; then
            matched_commands+=("$entry")
          fi
        done
      else
        matched_commands=("${commands[@]}")
      fi

      _describe 'command' matched_commands
      ;;
  esac
}

_claude "$@"
